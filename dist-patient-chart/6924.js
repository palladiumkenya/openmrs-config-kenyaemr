"use strict";(globalThis.webpackChunk_openmrs_esm_patient_chart_app=globalThis.webpackChunk_openmrs_esm_patient_chart_app||[]).push([[6924],{26924:(t,e,i)=>{i.r(e),i.d(e,{default:()=>F});var n=i(1343),r=i.n(n),a=i(53373),o=i.n(a),s=i(80824),l=i(72339),u=i(71123),c=i(75198),m=i(81160),d=i(54440),v=i(63276),p=i(39173),f=i(62543),b=i(38361),y=i(39144),g=i(83),h=i(27926),E=i(98009),S=i(90781);function w(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function A(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function T(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,r,a=[],o=!0,s=!1;try{for(i=i.call(t);!(o=(n=i.next()).done)&&(a.push(n.value),!e||a.length!==e);o=!0);}catch(t){s=!0,r=t}finally{try{o||null==i.return||i.return()}finally{if(s)throw r}}return a}}(t,e)||C(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function V(t){return function(t){if(Array.isArray(t))return w(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||C(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function C(t,e){if(t){if("string"==typeof t)return w(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?w(t,e):void 0}}var k=r().memo((function(t){var e=t.name,i=t.patientUuid,n=t.visitFormOpenedFrom,a=t.setVisitFormCallbacks,o=(0,d.useConfig)();return r().createElement(d.ExtensionSlot,{name:e},(function(t){var e={patientUuid:i,setVisitFormCallbacks:function(e){a((function(i){return new Map(i).set(t.id,e)}))},visitFormOpenedFrom:n,patientChartConfig:o};return r().createElement(d.Extension,{state:e})}))}));const F=function(t){var e,i=t.closeWorkspace,a=t.handleReturnToSearchList,w=t.openedFrom,C=t.patient,F=t.patientUuid,N=t.promptBeforeClosing,U=t.showPatientHeader,x=void 0!==U&&U,O=t.visitToEdit,P=(0,l.useTranslation)().t,I="tablet"===(0,d.useLayoutType)(),D=(0,d.useConnectivity)(),L=(0,d.useConfig)(),j=(0,d.useEmrConfiguration)().emrConfiguration,B=T((0,n.useState)(L.showRecommendedVisitTypeTab?0:1),2),R=B[0],_=B[1],z=(0,n.useMemo)((function(){return{patientUuid:F}}),[F]),G=(0,v.useActivePatientEnrollment)(F),M=G.activePatientEnrollment,W=G.isLoading,H=(0,d.useVisit)(F).mutate,X=(0,u.iX)().mutate,Z=(0,f.as)(),$=(0,v.usePatientChartStore)(F).setVisitContext,q=T((0,n.useState)(null),2),J=q[0],K=q[1],Q=(0,E.s2)().visitAttributeTypes,Y=T((0,f.rM)(),2),tt=Y[0],et=Y[1],it=T((0,n.useState)(null),2),nt=it[0],rt=it[1],at=(0,f.aZ)(O),ot=at.visitFormSchema,st=at.defaultValues,lt=at.firstEncounterDateTime,ut=at.lastEncounterDateTime,ct=(0,s.mN)({mode:"all",resolver:(0,m.u)(ot),defaultValues:st}),mt=ct.handleSubmit,dt=ct.control,vt=ct.getValues,pt=ct.formState,ft=pt.errors,bt=pt.isDirty,yt=pt.isSubmitting,gt=ct.reset;(0,n.useEffect)((function(){gt(st)}),[st,gt]),(0,n.useEffect)((function(){N((function(){return bt}))}),[bt,N]);var ht,Et=(0,n.useCallback)((function(t){return Array.isArray(t)&&t.length>0&&t.every((function(t){var e,i;return(null==t||null===(e=t.attributeType)||void 0===e?void 0:e.trim().length)>0&&(null==t||null===(i=t.value)||void 0===i?void 0:i.trim().length)>0}))}),[]),St=(0,n.useCallback)((function(t,e){var i,n=(null==O||null===(i=O.attributes)||void 0===i?void 0:i.map((function(t){return t.attributeType.uuid})))||[],r=[],a=!0,o=!1,s=void 0;try{for(var l,u=function(){var t,i=T(l.value,2),a=i[0],o=i[1];if(a&&n.includes(a)){var s=O.attributes.find((function(t){return t.attributeType.uuid===a}));if(s){if("object"==((t=s.value)&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t)?s.value.uuid===o:s.value===o)return"continue";o?r.push((0,f.bP)(e,s.uuid,o).catch((function(t){return(0,d.showSnackbar)({title:P("errorUpdatingVisitAttribute","Error updating the {{attributeName}} visit attribute",{attributeName:s.attributeType.display}),kind:"error",isLowContrast:!1,subtitle:null==t?void 0:t.message}),Promise.reject(t)}))):r.push((0,f.Tw)(e,s.uuid).catch((function(t){return(0,d.showSnackbar)({title:P("errorDeletingVisitAttribute","Error deleting the {{attributeName}} visit attribute",{attributeName:s.attributeType.display}),kind:"error",isLowContrast:!1,subtitle:null==t?void 0:t.message}),Promise.reject(t)})))}}else o&&r.push((0,f.Uv)(e,a,o).catch((function(t){var e;return(0,d.showSnackbar)({title:P("errorCreatingVisitAttribute","Error creating the {{attributeName}} visit attribute",{attributeName:null==Q||null===(e=Q.find((function(t){return t.uuid===a})))||void 0===e?void 0:e.display}),kind:"error",isLowContrast:!1,subtitle:null==t?void 0:t.message}),Promise.reject(t)})))},c=Object.entries(t)[Symbol.iterator]();!(a=(l=c.next()).done);a=!0)u()}catch(t){o=!0,s=t}finally{try{a||null==c.return||c.return()}finally{if(o)throw s}}return Promise.all(r)}),[O,P,Q]),wt=(0,n.useCallback)((function(t){var e=t.visitStatus,n=t.visitStartTimeFormat,r=t.visitStartDate,a=t.visitLocation,o=t.visitStartTime,s=t.visitType,l=t.visitAttributes,u=t.visitStopDate,c=t.visitStopTime,m=t.visitStopTimeFormat,p=null!=nt?nt:{},b=p.handleCreateExtraVisitInfo,y=p.attributes,g=["ongoing","past"].includes(e),h="past"===e,E=(0,f.zL)(r,o,n),S=(0,f.zL)(u,c,m),w=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},n=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(i).filter((function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable})))),n.forEach((function(e){A(t,e,i[e])}))}return t}({visitType:s,location:null==a?void 0:a.uuid,startDatetime:g?E:null,stopDatetime:h?S:null},!O&&{patient:F},Et(y)&&{attributes:y});null==b||b();var T=new AbortController;D?((null==O?void 0:O.uuid)?(0,d.updateVisit)(null==O?void 0:O.uuid,w,T):(0,d.saveVisit)(w,T)).then((function(t){var e,i,n,r,a,o;return(0,d.showSnackbar)({isLowContrast:!0,kind:"success",subtitle:O?P("visitDetailsUpdatedSuccessfully","{{visit}} updated successfully",{visit:null!==(o=null==t||null===(r=t.data)||void 0===r||null===(n=r.visitType)||void 0===n?void 0:n.display)&&void 0!==o?o:P("pastVisit","Past visit")}):P("visitStartedSuccessfully","{{visit}} started successfully",{visit:null!==(a=null==t||null===(i=t.data)||void 0===i||null===(e=i.visitType)||void 0===e?void 0:e.display)&&void 0!==a?a:P("visit","Visit")}),title:O?P("visitDetailsUpdated","Visit details updated"):P("visitStarted","Visit started")}),t})).catch((function(t){var e,i,n=d.OpenmrsFetchError&&(e=t,null!=(i=d.OpenmrsFetchError)&&"undefined"!=typeof Symbol&&i[Symbol.hasInstance]?i[Symbol.hasInstance](e):e instanceof i)?"string"==typeof t.responseBody?t.responseBody:(0,f.je)(t.responseBody,P):null==t?void 0:t.message;return(0,d.showSnackbar)({title:O?P("errorUpdatingVisitDetails","Error updating visit details"):P("startVisitError","Error starting visit"),kind:"error",isLowContrast:!1,subtitle:n}),Promise.reject(t)})).then((function(t){var e=t.data,i=function(){return(0,v.invalidateVisitByUuid)(X,e.uuid)};H(),null==$||$(e,i),O&&i(),(0,v.invalidateVisitAndEncounterData)(X,F);var n=St(l,t.data.uuid).then((function(t){t.length>0&&(0,d.showSnackbar)({isLowContrast:!0,kind:"success",title:P("additionalVisitInformationUpdatedSuccessfully","Additional visit information updated successfully")})})),r=V(tt.values()).map((function(t){return t.onVisitCreatedOrUpdated(e)}));return Promise.all([n].concat(V(r)))})).then((function(){i({ignoreChanges:!0}),L.customUrlAfterSubmit&&(0,d.navigate)({to:L.customUrlAfterSubmit})})).catch((function(){})):(0,v.createOfflineVisitForPatient)(F,a.uuid,L.offlineVisitTypeUuid,w.startDatetime).then((function(t){var e=function(){return(0,v.invalidateVisitByUuid)(X,t.uuid)};H(),null==$||$(t,e),O&&e(),(0,v.invalidateVisitAndEncounterData)(X,F),i({ignoreChanges:!0}),(0,d.showSnackbar)({isLowContrast:!0,kind:"success",subtitle:P("visitStartedSuccessfully","{{visit}} started successfully",{visit:P("offlineVisit","Offline Visit")}),title:P("visitStarted","Visit started")}),L.customUrlAfterSubmit&&(0,d.navigate)({to:L.customUrlAfterSubmit})}),(function(t){(0,d.showSnackbar)({title:P("startVisitError","Error starting visit"),kind:"error",isLowContrast:!1,subtitle:null==t?void 0:t.message})}))}),[i,L.offlineVisitTypeUuid,L.customUrlAfterSubmit,nt,X,St,D,$,F,P,tt,O,Et,H]),At=(0,n.useCallback)((function(){a?a():i()}),[a,i]);return r().createElement(s.Op,ct,r().createElement(c.Form,{className:S.A.form,onSubmit:mt(wt),"data-openmrs-role":"Start Visit Form"},x&&C&&r().createElement(d.ExtensionSlot,{name:"patient-header-slot",state:{patient:C,patientUuid:F,hideActionsOverflow:!0}}),J&&r().createElement(c.InlineNotification,{kind:(null==J?void 0:J.blockSavingForm)?"error":"warning",lowContrast:!0,className:S.A.inlineNotification,title:P("partOfFormDidntLoad","Part of the form did not load"),subtitle:P("refreshToTryAgain","Please refresh to try again")}),r().createElement("div",null,I&&r().createElement(c.Row,{className:S.A.headerGridRow},r().createElement(d.ExtensionSlot,{name:"visit-form-header-slot",className:S.A.dataGridRow,state:z})),r().createElement(c.Stack,{gap:4,className:S.A.container},r().createElement("section",null,r().createElement(c.FormGroup,{legendText:P("theVisitIs","The visit is")},r().createElement(s.xI,{name:"visitStatus",control:dt,render:function(t){var e=t.field,i=e.onChange,n=e.value,a=(O?["ongoing","past"]:f.e5).indexOf(n),o=a>=0?a:0;return O?r().createElement(c.ContentSwitcher,{selectedIndex:o,onChange:function(t){var e=t.name;return i(e)},size:"md"},r().createElement(c.Switch,{name:"ongoing",text:P("ongoing","Ongoing")}),r().createElement(c.Switch,{name:"past",text:P("ended","Ended")})):r().createElement(c.ContentSwitcher,{selectedIndex:o,onChange:function(t){var e=t.name;return i(e)},size:"md"},r().createElement(c.Switch,{name:"new",text:P("new","New")}),r().createElement(c.Switch,{name:"ongoing",text:P("ongoing","Ongoing")}),r().createElement(c.Switch,{name:"past",text:P("inThePast","In the past")}))}}))),r().createElement(h.A,{control:dt,firstEncounterDateTime:lt,lastEncounterDateTime:ut}),L.showUpcomingAppointments&&r().createElement("section",null,r().createElement("div",{className:S.A.sectionField},r().createElement(k,{name:"visit-form-top-slot",patientUuid:F,visitFormOpenedFrom:w,setVisitFormCallbacks:et}))),r().createElement(y.A,{control:dt}),L.showRecommendedVisitTypeTab&&r().createElement("section",null,r().createElement("h1",{className:S.A.sectionTitle},P("program","Program")),r().createElement(c.FormGroup,{legendText:P("selectProgramType","Select program type"),className:S.A.sectionField},r().createElement(s.xI,{name:"programType",control:dt,render:function(t){var e=t.field.onChange;return r().createElement(c.RadioButtonGroup,{orientation:"vertical",onChange:function(t){var i;return e(null===(i=M.find((function(e){return e.program.uuid===t})))||void 0===i?void 0:i.uuid)},name:"program-type-radio-group"},M.map((function(t){var e=t.uuid,i=t.display,n=t.program;return r().createElement(c.RadioButton,{key:e,className:S.A.radioButton,id:e,labelText:i,value:n.uuid})})))}}))),!(null==j?void 0:j.atFacilityVisitType)&&r().createElement("section",null,r().createElement("h1",{className:S.A.sectionTitle},P("visitType_title","Visit Type")),r().createElement("div",{className:S.A.sectionField},L.showRecommendedVisitTypeTab?r().createElement(r().Fragment,null,r().createElement(c.ContentSwitcher,{selectedIndex:R,onChange:function(t){var e=t.index;return _(e)},size:"md"},r().createElement(c.Switch,{name:"recommended",text:P("recommended","Recommended")}),r().createElement(c.Switch,{name:"all",text:P("all","All")})),0===R&&!W&&r().createElement(p.z,{patientUuid:F,patientProgramEnrollment:null==M?void 0:M.find((function(t){return t.program.uuid===vt("programType")})),locationUuid:null===(e=vt("visitLocation"))||void 0===e?void 0:e.uuid}),1===R&&r().createElement(b.A,{visitTypes:Z})):r().createElement(b.A,{visitTypes:Z})),(null==ft?void 0:ft.visitType)&&r().createElement("section",null,r().createElement("div",{className:S.A.sectionField},r().createElement(c.InlineNotification,{role:"alert",style:{margin:"0",minWidth:"100%"},kind:"error",lowContrast:!0,title:P("missingVisitType","Missing visit type"),subtitle:P("selectVisitType","Please select a Visit Type")})))),r().createElement("section",null,r().createElement("h1",{className:S.A.sectionTitle},I&&P("visitAttributes","Visit attributes")),r().createElement("div",{className:S.A.sectionField},r().createElement(g.A,{setErrorFetchingResources:K}))),r().createElement(k,{name:"visit-form-bottom-slot",patientUuid:F,visitFormOpenedFrom:w,setVisitFormCallbacks:et}),r().createElement("section",null,r().createElement("div",{className:S.A.sectionField})),r().createElement(d.ExtensionSlot,{state:{patientUuid:F,setExtraVisitInfo:rt},name:"extra-visit-attribute-slot"}))),r().createElement(c.ButtonSet,{className:o()(S.A.buttonSet,(ht={},A(ht,S.A.tablet,I),A(ht,S.A.desktop,!I),ht))},r().createElement(c.Button,{className:S.A.button,kind:"secondary",onClick:At},P("discard","Discard")),r().createElement(c.Button,{className:S.A.button,disabled:yt||(null==J?void 0:J.blockSavingForm),kind:"primary",type:"submit"},yt?r().createElement(c.InlineLoading,{className:S.A.spinner,description:O?P("updatingVisit","Updating visit")+"...":P("startingVisit","Starting visit")+"..."}):r().createElement("span",null,O?P("updateVisit","Update visit"):P("startVisit","Start visit"))))))}}}]);