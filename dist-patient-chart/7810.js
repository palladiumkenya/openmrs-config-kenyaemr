"use strict";(globalThis.webpackChunk_openmrs_esm_patient_chart_app=globalThis.webpackChunk_openmrs_esm_patient_chart_app||[]).push([[7810],{87810:(t,e,n)=>{n.r(e),n.d(e,{default:()=>O});var i=n(1343),r=n.n(i),a=n(53373),o=n.n(a),s=n(80824),l=n(72339),u=n(71123),c=n(75198),d=n(81160),m=n(54440),p=n(63276),f=n(39173),v=n(62543),b=n(38361),y=n(39144),h=n(83),g=n(27926),E=n(98009),S=n(90781);function w(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function T(t,e,n,i,r,a,o){try{var s=t[a](o),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(i,r)}function A(t){return function(){var e=this,n=arguments;return new Promise((function(i,r){var a=t.apply(e,n);function o(t){T(a,i,r,o,s,"next",t)}function s(t){T(a,i,r,o,s,"throw",t)}o(void 0)}))}}function V(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function k(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var i,r,a=[],o=!0,s=!1;try{for(n=n.call(t);!(o=(i=n.next()).done)&&(a.push(i.value),!e||a.length!==e);o=!0);}catch(t){s=!0,r=t}finally{try{o||null==n.return||n.return()}finally{if(s)throw r}}return a}}(t,e)||F(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function C(t){return function(t){if(Array.isArray(t))return w(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||F(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function F(t,e){if(t){if("string"==typeof t)return w(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?w(t,e):void 0}}function x(t,e){var n,i,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(n=1,i&&(r=2&s[0]?i.return:s[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,s[1])).done)return r;switch(i=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],i=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}}var N=r().memo((function(t){var e=t.name,n=t.patientUuid,i=t.visitFormOpenedFrom,a=t.setVisitFormCallbacks,o=(0,m.useConfig)();return r().createElement(m.ExtensionSlot,{name:e},(function(t){var e={patientUuid:n,setVisitFormCallbacks:function(e){a((function(n){return new Map(n).set(t.id,e)}))},visitFormOpenedFrom:i,patientChartConfig:o};return r().createElement(m.Extension,{state:e})}))}));const O=function(t){var e,n=t.closeWorkspace,a=t.workspaceProps,w=a.openedFrom,T=a.showPatientHeader,F=void 0!==T&&T,O=a.onVisitStarted,P=a.patient,U=a.patientUuid,I=a.visitContext,j=(0,l.useTranslation)().t,D="tablet"===(0,m.useLayoutType)(),L=(0,m.useConnectivity)(),_=(0,m.useConfig)(),R=(0,m.useEmrConfiguration)().emrConfiguration,B=k((0,i.useState)(_.showRecommendedVisitTypeTab?0:1),2),z=B[0],G=B[1],M=(0,i.useMemo)((function(){return{patientUuid:U}}),[U]),W=(0,p.useActivePatientEnrollment)(U),H=W.activePatientEnrollment,X=W.isLoading,Z=(0,u.iX)().mutate,$=(0,v.as)(),q=k((0,i.useState)(null),2),J=q[0],K=q[1],Q=(0,E.s2)().visitAttributeTypes,Y=k((0,v.rM)(),2),tt=Y[0],et=Y[1],nt=k((0,i.useState)(null),2),it=nt[0],rt=nt[1],at=(0,v.aZ)(I),ot=at.visitFormSchema,st=at.defaultValues,lt=at.firstEncounterDateTime,ut=at.lastEncounterDateTime,ct=(0,s.mN)({mode:"all",resolver:(0,d.u)(ot),defaultValues:st}),dt=ct.handleSubmit,mt=ct.control,pt=ct.getValues,ft=ct.formState,vt=ft.errors,bt=ft.isDirty,yt=ft.isSubmitting,ht=ct.reset;(0,i.useEffect)((function(){ht(st)}),[st,ht]);var gt,Et=(0,i.useCallback)((function(t){return Array.isArray(t)&&t.length>0&&t.every((function(t){var e,n;return(null==t||null===(e=t.attributeType)||void 0===e?void 0:e.trim().length)>0&&(null==t||null===(n=t.value)||void 0===n?void 0:n.trim().length)>0}))}),[]),St=(0,i.useCallback)((function(t,e){var n,i=(null==I||null===(n=I.attributes)||void 0===n?void 0:n.map((function(t){return t.attributeType.uuid})))||[],r=[],a=!0,o=!1,s=void 0;try{for(var l,u=function(){var t,n=k(l.value,2),a=n[0],o=n[1];if(a&&i.includes(a)){var s=I.attributes.find((function(t){return t.attributeType.uuid===a}));if(s){if("object"==((t=s.value)&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t)?s.value.uuid===o:s.value===o)return"continue";o?r.push((0,v.bP)(e,s.uuid,o).catch((function(t){return(0,m.showSnackbar)({title:j("errorUpdatingVisitAttribute","Error updating the {{attributeName}} visit attribute",{attributeName:s.attributeType.display}),kind:"error",isLowContrast:!1,subtitle:null==t?void 0:t.message}),Promise.reject(t)}))):r.push((0,v.Tw)(e,s.uuid).catch((function(t){return(0,m.showSnackbar)({title:j("errorDeletingVisitAttribute","Error deleting the {{attributeName}} visit attribute",{attributeName:s.attributeType.display}),kind:"error",isLowContrast:!1,subtitle:null==t?void 0:t.message}),Promise.reject(t)})))}}else o&&r.push((0,v.Uv)(e,a,o).catch((function(t){var e;return(0,m.showSnackbar)({title:j("errorCreatingVisitAttribute","Error creating the {{attributeName}} visit attribute",{attributeName:null==Q||null===(e=Q.find((function(t){return t.uuid===a})))||void 0===e?void 0:e.display}),kind:"error",isLowContrast:!1,subtitle:null==t?void 0:t.message}),Promise.reject(t)})))},c=Object.entries(t)[Symbol.iterator]();!(a=(l=c.next()).done);a=!0)u()}catch(t){o=!0,s=t}finally{try{a||null==c.return||c.return()}finally{if(o)throw s}}return Promise.all(r)}),[I,j,Q]),wt=(0,i.useCallback)((function(t){var e=t.visitStatus,i=t.visitStartTimeFormat,r=t.visitStartDate,a=t.visitLocation,o=t.visitStartTime,s=t.visitType,l=t.visitAttributes,u=t.visitStopDate,c=t.visitStopTime,d=t.visitStopTimeFormat,f=null!=it?it:{},b=f.handleCreateExtraVisitInfo,y=f.attributes,h=["ongoing","past"].includes(e),g="past"===e,E=(0,v.zL)(r,o,i),S=(0,v.zL)(u,c,d),w=function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable})))),i.forEach((function(e){V(t,e,n[e])}))}return t}({visitType:s,location:null==a?void 0:a.uuid,startDatetime:h?E:null,stopDatetime:g?S:null},!I&&{patient:U},Et(y)&&{attributes:y});null==b||b();var T=new AbortController;L?((null==I?void 0:I.uuid)?(0,m.updateVisit)(null==I?void 0:I.uuid,w,T):(0,m.saveVisit)(w,T)).then((function(t){var e,n,i,r,a,o;return(0,m.showSnackbar)({isLowContrast:!0,kind:"success",subtitle:I?j("visitDetailsUpdatedSuccessfully","{{visit}} updated successfully",{visit:null!==(o=null==t||null===(r=t.data)||void 0===r||null===(i=r.visitType)||void 0===i?void 0:i.display)&&void 0!==o?o:j("pastVisit","Past visit")}):j("visitStartedSuccessfully","{{visit}} started successfully",{visit:null!==(a=null==t||null===(n=t.data)||void 0===n||null===(e=n.visitType)||void 0===e?void 0:e.display)&&void 0!==a?a:j("visit","Visit")}),title:I?j("visitDetailsUpdated","Visit details updated"):j("visitStarted","Visit started")}),t})).catch((function(t){var e,n,i=m.OpenmrsFetchError&&(e=t,null!=(n=m.OpenmrsFetchError)&&"undefined"!=typeof Symbol&&n[Symbol.hasInstance]?n[Symbol.hasInstance](e):e instanceof n)?"string"==typeof t.responseBody?t.responseBody:(0,v.je)(t.responseBody,j):null==t?void 0:t.message;return(0,m.showSnackbar)({title:I?j("errorUpdatingVisitDetails","Error updating visit details"):j("startVisitError","Error starting visit"),kind:"error",isLowContrast:!1,subtitle:i}),Promise.reject(t)})).then((function(t){return A((function(){var e,i,r;return x(this,(function(a){switch(a.label){case 0:return e=t.data,(0,p.invalidateVisitAndEncounterData)(Z,U),i=St(l,t.data.uuid).then((function(t){t.length>0&&(0,m.showSnackbar)({isLowContrast:!0,kind:"success",title:j("additionalVisitInformationUpdatedSuccessfully","Additional visit information updated successfully")})})),r=C(tt.values()).map((function(t){return t.onVisitCreatedOrUpdated(e)})),[4,Promise.all([i].concat(C(r)))];case 1:return a.sent(),[4,n({discardUnsavedChanges:!0})];case 2:return a.sent(),null==O||O(e),[2]}}))}))()})).catch((function(){})):(0,p.createOfflineVisitForPatient)(U,a.uuid,_.offlineVisitTypeUuid,w.startDatetime).then((function(t){return A((function(){return x(this,(function(e){switch(e.label){case 0:return(0,p.invalidateVisitAndEncounterData)(Z,U),(0,m.showSnackbar)({isLowContrast:!0,kind:"success",subtitle:j("visitStartedSuccessfully","{{visit}} started successfully",{visit:j("offlineVisit","Offline Visit")}),title:j("visitStarted","Visit started")}),[4,n({discardUnsavedChanges:!0})];case 1:return e.sent(),null==O||O(t),[2]}}))}))()}),(function(t){return(0,m.showSnackbar)({title:j("startVisitError","Error starting visit"),kind:"error",isLowContrast:!1,subtitle:null==t?void 0:t.message}),Promise.reject(t)}))}),[n,_.offlineVisitTypeUuid,it,Z,St,L,O,U,j,tt,I,Et]);return r().createElement(m.Workspace2,{title:I?j("editVisit","Edit visit"):j("startVisitWorkspaceTitle","Start a visit"),hasUnsavedChanges:bt},r().createElement(s.Op,ct,r().createElement(c.Form,{className:S.A.form,onSubmit:dt(wt),"data-openmrs-role":"Start Visit Form"},F&&P&&r().createElement(m.ExtensionSlot,{name:"patient-header-slot",state:{patient:P,patientUuid:U,hideActionsOverflow:!0}}),J&&r().createElement(c.InlineNotification,{kind:(null==J?void 0:J.blockSavingForm)?"error":"warning",lowContrast:!0,className:S.A.inlineNotification,title:j("partOfFormDidntLoad","Part of the form did not load"),subtitle:j("refreshToTryAgain","Please refresh to try again")}),r().createElement("div",null,D&&r().createElement(c.Row,{className:S.A.headerGridRow},r().createElement(m.ExtensionSlot,{name:"visit-form-header-slot",className:S.A.dataGridRow,state:M})),r().createElement(c.Stack,{gap:4,className:S.A.container},r().createElement("section",null,r().createElement(c.FormGroup,{legendText:j("theVisitIs","The visit is")},r().createElement(s.xI,{name:"visitStatus",control:mt,render:function(t){var e=t.field,n=e.onChange,i=e.value,a=(I?["ongoing","past"]:v.e5).indexOf(i),o=a>=0?a:0;return I?r().createElement(c.ContentSwitcher,{selectedIndex:o,onChange:function(t){var e=t.name;return n(e)},size:"md"},r().createElement(c.Switch,{name:"ongoing",text:j("ongoing","Ongoing")}),r().createElement(c.Switch,{name:"past",text:j("ended","Ended")})):r().createElement(c.ContentSwitcher,{selectedIndex:o,onChange:function(t){var e=t.name;return n(e)},size:"md"},r().createElement(c.Switch,{name:"new",text:j("new","New")}),r().createElement(c.Switch,{name:"ongoing",text:j("ongoing","Ongoing")}),r().createElement(c.Switch,{name:"past",text:j("inThePast","In the past")}))}}))),r().createElement(g.A,{control:mt,firstEncounterDateTime:lt,lastEncounterDateTime:ut}),_.showUpcomingAppointments&&r().createElement("section",null,r().createElement("div",{className:S.A.sectionField},r().createElement(N,{name:"visit-form-top-slot",patientUuid:U,visitFormOpenedFrom:w,setVisitFormCallbacks:et}))),r().createElement(y.A,{control:mt}),_.showRecommendedVisitTypeTab&&r().createElement("section",null,r().createElement("h1",{className:S.A.sectionTitle},j("program","Program")),r().createElement(c.FormGroup,{legendText:j("selectProgramType","Select program type"),className:S.A.sectionField},r().createElement(s.xI,{name:"programType",control:mt,render:function(t){var e=t.field.onChange;return r().createElement(c.RadioButtonGroup,{orientation:"vertical",onChange:function(t){var n;return e(null===(n=H.find((function(e){return e.program.uuid===t})))||void 0===n?void 0:n.uuid)},name:"program-type-radio-group"},H.map((function(t){var e=t.uuid,n=t.display,i=t.program;return r().createElement(c.RadioButton,{key:e,className:S.A.radioButton,id:e,labelText:n,value:i.uuid})})))}}))),!(null==R?void 0:R.atFacilityVisitType)&&r().createElement("section",null,r().createElement("h1",{className:S.A.sectionTitle},j("visitType_title","Visit Type")),r().createElement("div",{className:S.A.sectionField},_.showRecommendedVisitTypeTab?r().createElement(r().Fragment,null,r().createElement(c.ContentSwitcher,{selectedIndex:z,onChange:function(t){var e=t.index;return G(e)},size:"md"},r().createElement(c.Switch,{name:"recommended",text:j("recommended","Recommended")}),r().createElement(c.Switch,{name:"all",text:j("all","All")})),0===z&&!X&&r().createElement(f.z,{patientUuid:U,patientProgramEnrollment:null==H?void 0:H.find((function(t){return t.program.uuid===pt("programType")})),locationUuid:null===(e=pt("visitLocation"))||void 0===e?void 0:e.uuid}),1===z&&r().createElement(b.A,{visitTypes:$})):r().createElement(b.A,{visitTypes:$})),(null==vt?void 0:vt.visitType)&&r().createElement("section",null,r().createElement("div",{className:S.A.sectionField},r().createElement(c.InlineNotification,{role:"alert",style:{margin:"0",minWidth:"100%"},kind:"error",lowContrast:!0,title:j("missingVisitType","Missing visit type"),subtitle:j("selectVisitType","Please select a Visit Type")})))),r().createElement(m.ExtensionSlot,{state:{patientUuid:U,setExtraVisitInfo:rt},name:"extra-visit-attribute-slot"}),r().createElement("section",null,r().createElement("h1",{className:S.A.sectionTitle},D&&j("visitAttributes","Visit attributes")),r().createElement("div",{className:S.A.sectionField},r().createElement(h.A,{setErrorFetchingResources:K}))),r().createElement("section",null,r().createElement("div",{className:S.A.sectionField},r().createElement(N,{name:"visit-form-bottom-slot",patientUuid:U,visitFormOpenedFrom:w,setVisitFormCallbacks:et}))))),r().createElement(c.ButtonSet,{className:o()(S.A.buttonSet,(gt={},V(gt,S.A.tablet,D),V(gt,S.A.desktop,!D),gt))},r().createElement(c.Button,{className:S.A.button,kind:"secondary",onClick:function(){return n()}},j("discard","Discard")),r().createElement(c.Button,{className:S.A.button,disabled:yt||(null==J?void 0:J.blockSavingForm),kind:"primary",type:"submit"},yt?r().createElement(c.InlineLoading,{className:S.A.spinner,description:I?j("updatingVisit","Updating visit")+"...":j("startingVisit","Starting visit")+"..."}):r().createElement("span",null,I?j("updateVisit","Update visit"):j("startVisit","Start visit")))))))}}}]);